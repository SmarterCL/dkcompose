version: "3.9"

networks:
  smarter-net:
    driver: bridge
  dokploy-network:
    external: true

volumes:
  postgres_data:
  redis_data:
  n8n_data:
  portainer_data:
  botpress_data:
  odoo_extra_addons:
  chatwoot_data:
  vault_data:
  metabase_data:

services:
  postgres:
    image: ankane/pgvector:latest
    container_name: smarter-postgres
    restart: always
    environment:
      POSTGRES_USER: smarter
      POSTGRES_PASSWORD: smarter
      POSTGRES_DB: smarter
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U smarter -d smarter || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - smarter-net

  db-init-chatwoot:
    image: postgres:16
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGPASSWORD: smarter
    entrypoint: >
      sh -lc "
      psql -h smarter-postgres -U smarter -d smarter -v ON_ERROR_STOP=1 -c
      \"DO $$
      BEGIN
        IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'chatwoot') THEN
          CREATE ROLE chatwoot LOGIN PASSWORD 'chatwoot';
        END IF;
        IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'chatwoot') THEN
          CREATE DATABASE chatwoot OWNER chatwoot;
        END IF;
      END$$;\"
      "
    restart: "no"
    networks:
      - smarter-net

  redis:
    image: redis:7-alpine
    container_name: smarter-redis
    restart: always
    command: ["redis-server","--save","20","1","--loglevel","warning"]
    volumes:
      - redis_data:/data
    networks:
      - smarter-net

  odoo:
    image: odoo:19
    container_name: smarter-odoo
    restart: always
    depends_on:
      - postgres
    environment:
      HOST: smarter-postgres
      USER: smarter
      PASSWORD: smarter
    volumes:
      - odoo_extra_addons:/mnt/extra-addons
    networks:
      - smarter-net
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.odoo.rule=Host(`odoo.smarterbot.cl`)"
      - "traefik.http.routers.odoo.entrypoints=websecure"
      - "traefik.http.routers.odoo.tls.certresolver=letsencrypt"
      - "traefik.http.services.odoo.loadbalancer.server.port=8069"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8069/web/login || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s

  n8n:
    image: n8nio/n8n:latest
    container_name: smarter-n8n
    restart: always
    environment:
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: smarter-postgres
      DB_POSTGRESDB_DATABASE: smarter
      DB_POSTGRESDB_USER: smarter
      DB_POSTGRESDB_PASSWORD: smarter
      GENERIC_TIMEZONE: America/Santiago
      WEBHOOK_URL: https://n8n.smarterbot.cl/
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - smarter-net
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.smarterbot.cl`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certresolver=letsencrypt"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:5678/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s

  botpress:
    image: botpress/server:latest
    container_name: smarter-botpress
    restart: always
    environment:
      - BP_PRODUCTION=true
    volumes:
      - botpress_data:/botpress
    networks:
      - smarter-net
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.botpress.rule=Host(`chat.smarterbot.cl`)"
      - "traefik.http.routers.botpress.entrypoints=websecure"
      - "traefik.http.routers.botpress.tls.certresolver=letsencrypt"
      - "traefik.http.services.botpress.loadbalancer.server.port=3000"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

  portainer:
    image: portainer/portainer-ce:latest
    container_name: smarter-portainer
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - smarter-net
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`portainer.smarterbot.cl`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls.certresolver=letsencrypt"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"

  chatwoot:
    image: ghcr.io/chatwoot/chatwoot:v2.10.1
    container_name: smarter-chatwoot
    restart: always
    depends_on:
      - postgres
      - redis
      - db-init-chatwoot
    environment:
      RAILS_ENV: production
      NODE_ENV: production
      FRONTEND_URL: https://chatwoot.smarterbot.cl
      SECRET_KEY_BASE: 00bfdfdb2402399fcf7ef0d2fde183b4fd42709666e65f337505c26e1b74c4f6ca38987355208007c4a165989d0d7dfef5e6a3a0b5c7aa8ca93c9e9226250278
      REDIS_URL: redis://smarter-redis:6379
      DATABASE_URL: postgres://chatwoot:chatwoot@smarter-postgres:5432/chatwoot
      RAILS_SERVE_STATIC_FILES: "true"
    volumes:
      - chatwoot_data:/app/storage
    networks:
      - smarter-net
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.chatwoot.rule=Host(`chatwoot.smarterbot.cl`)"
      - "traefik.http.routers.chatwoot.entrypoints=websecure"
      - "traefik.http.routers.chatwoot.tls.certresolver=letsencrypt"
      - "traefik.http.services.chatwoot.loadbalancer.server.port=3000"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s

  chatwoot-worker:
    image: ghcr.io/chatwoot/chatwoot:v2.10.1
    container_name: smarter-chatwoot-worker
    restart: always
    depends_on:
      - chatwoot
    command: ["sh","-lc","bundle exec sidekiq"]
    environment:
      RAILS_ENV: production
      SECRET_KEY_BASE: 00bfdfdb2402399fcf7ef0d2fde183b4fd42709666e65f337505c26e1b74c4f6ca38987355208007c4a165989d0d7dfef5e6a3a0b5c7aa8ca93c9e9226250278
      REDIS_URL: redis://smarter-redis:6379
      DATABASE_URL: postgres://chatwoot:chatwoot@smarter-postgres:5432/chatwoot
    networks:
      - smarter-net
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f sidekiq || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

  chatwoot-scheduler:
    image: ghcr.io/chatwoot/chatwoot:v2.10.1
    container_name: smarter-chatwoot-scheduler
    restart: always
    depends_on:
      - chatwoot
    command: ["sh","-lc","bundle exec whenever --update-crontab && crond -f -l 2"]
    environment:
      RAILS_ENV: production
      SECRET_KEY_BASE: 00bfdfdb2402399fcf7ef0d2fde183b4fd42709666e65f337505c26e1b74c4f6ca38987355208007c4a165989d0d7dfef5e6a3a0b5c7aa8ca93c9e9226250278
      REDIS_URL: redis://smarter-redis:6379
      DATABASE_URL: postgres://chatwoot:chatwoot@smarter-postgres:5432/chatwoot
    networks:
      - smarter-net
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f crond || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s

  # ---------------------------------------------
  # Redpanda (Kafka-compatible) + Console
  # ---------------------------------------------
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    container_name: smarter-redpanda
    restart: always
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp=1
      - --memory=1G
      - --reserve-memory=0M
      - --set redpanda.auto_create_topics_enabled=true
      - --advertise-kafka-addr=PLAINTEXT://smarter-redpanda:9092
      - --kafka-addr=PLAINTEXT://0.0.0.0:9092
      - --advertise-rpc-addr=smarter-redpanda:33145
      - --rpc-addr=0.0.0.0:33145
      - --mode=dev-container
    ports:
      - "9092:9092"
      - "9644:9644"
    networks:
      - smarter-net

  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:latest
    container_name: smarter-redpanda-console
    restart: always
    environment:
      KAFKA_BROKERS: smarter-redpanda:9092
      KAFKA_TLS_ENABLED: "false"
    depends_on:
      - redpanda
    networks:
      - smarter-net
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.redpanda.rule=Host(`kafka.smarterbot.cl`)"
      - "traefik.http.routers.redpanda.entrypoints=websecure"
      - "traefik.http.routers.redpanda.tls.certresolver=letsencrypt"
      - "traefik.http.services.redpanda.loadbalancer.server.port=8080"

  # ---------------------------------------------
  # Vault (Raft storage)
  # ---------------------------------------------
  vault:
    image: hashicorp/vault:1.15
    container_name: smarter-vault
    restart: unless-stopped
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_LOCAL_CONFIG: |
        ui = true
        listener "tcp" {
          address = "0.0.0.0:8200"
          tls_disable = 1
        }
        storage "raft" {
          path = "/vault/data"
        }
        disable_mlock = true
    volumes:
      - vault_data:/vault/data
    networks:
      - smarter-net
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vault.rule=Host(`vault.smarterbot.cl`)"
      - "traefik.http.routers.vault.entrypoints=websecure"
      - "traefik.http.routers.vault.tls.certresolver=letsencrypt"
      - "traefik.http.services.vault.loadbalancer.server.port=8200"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8200/v1/sys/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 50s

  api-smarterbot:
    build: ../api.smarterbot.cl
    container_name: api-smarterbot
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE=${SUPABASE_SERVICE_ROLE}
      - RESEND_API_KEY=${RESEND_API_KEY}
      - RESEND_FROM=${RESEND_FROM:-no-reply@smarterbot.cl}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-smarterbotcl@gmail.com}
    networks:
      - smarter-net
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api-smarterbot.rule=Host(`api.smarterbot.cl`)"
      - "traefik.http.routers.api-smarterbot.entrypoints=websecure"
      - "traefik.http.routers.api-smarterbot.tls=true"
      - "traefik.http.routers.api-smarterbot.tls.certresolver=letsencrypt"
      - "traefik.http.services.api-smarterbot.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request,sys; urllib.request.urlopen(\"http://localhost:8000/health\");'"]
      interval: 30s
      timeout: 5s
      healthcheck:
        test: ["CMD-SHELL", "wget -qO- http://localhost:9644/metrics || exit 1"]
        interval: 30s
        timeout: 5s
        retries: 5
        start_period: 40s
      retries: 5
      start_period: 20s

  metabase:
    image: metabase/metabase:latest
    container_name: smarter-metabase
    restart: always
    environment:
      MB_JETTY_PORT: 3000
      MB_SITE_URL: https://kpi.smarterbot.cl
    volumes:
      - metabase_data:/metabase-data
    networks:
      - smarter-net
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.metabase.rule=Host(`kpi.smarterbot.cl`)"
      - "traefik.http.routers.metabase.entrypoints=websecure"
      - "traefik.http.routers.metabase.tls.certresolver=letsencrypt"
      - "traefik.http.services.metabase.loadbalancer.server.port=3000"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s

  mcp-registry:
    image: nginx:alpine
    container_name: smarter-mcp-registry
    restart: always
    volumes:
      - ./mcp-registry:/usr/share/nginx/html:ro
    networks:
      - smarter-net
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mcp-registry.rule=Host(`mcp.smarterbot.cl`)"
      - "traefik.http.routers.mcp-registry.entrypoints=websecure"
      - "traefik.http.routers.mcp-registry.tls.certresolver=letsencrypt"
      - "traefik.http.services.mcp-registry.loadbalancer.server.port=80"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s
